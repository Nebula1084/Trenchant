
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
		<script type="text/javascript" src="js/libs/webgl-utils.js"></script>
        <script type="text/javascript" src="js/libs/jquery.min.js"></script>
        <script type="text/javascript" src="js/libs/glMatrix-0.9.5.min.js"></script>
		<script type="text/javascript" src="js/Trenchant.js"></script>
        <script type="text/javascript" src="js/obj/Object.js"></script>
        <script type="text/javascript" src="js/obj/Car.js"></script>
        <script type="text/javascript" src="js/obj/Animate.js"></script>
        <script type="text/javascript" src="js/obj/Material.js"></script>
        <script type="text/javascript" src="js/shader/PhongShader.js"></script>
        <script type="text/javascript" src="js/shader/Cook_Torrance.js"></script>
        <script type="text/javascript" src="js/shader/Ward.js"></script>
        <script type="text/javascript" src="js/shader/VertexShader.js"></script>
        <script type="text/javascript" src="js/loaders/OBJLoader.js"></script>				
		
	<script type="text/javascript">
	
		var gl;
        var car;
        
        Trenchant.eyePos = [0.0, 0.0, 100.0];
        Trenchant.eyeLookat = [0.0, 0.0, -1000.0];
        Trenchant.viewMatrix = mat4.create();
        
        document.addEventListener( 'mousemove', onDocumentMouseMove, false );
        document.onkeydown = onDocumentOnKeyDown;
        
	
		function initGL(canvas) {
			try {
				gl = canvas.getContext("experimental-webgl");
				gl.viewportWidth = canvas.width;
				gl.viewportHeight = canvas.height;
			} catch (e) {
			}
			if (!gl) {
				alert("Could not initialise WebGL, sorry :-(");
			}
		}
                
        var windowHalfX = window.innerWidth / 2;
        var windowHalfY = window.innerHeight / 2;
        var mvMatrix = mat4.create();
        var mvMatrixStack = [];
        var pMatrix = mat4.create();
        var viewMatrix = mat4.create();

        function mvPushMatrix() {
            var copy = mat4.create();
            mat4.set(mvMatrix, copy);
            mvMatrixStack.push(copy);
        }

        function mvPopMatrix() {
            if (mvMatrixStack.length == 0) {
                throw "Invalid popMatrix!";
            }
            mvMatrix = mvMatrixStack.pop();
        }

        function degToRad(degrees) {
            return degrees * Math.PI / 180;
        }	
        
        var teapotAngle = 180;

        function drawScene() {        
            gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            if (car.object3d==null)
                return;

            mat4.lookAt(Trenchant.eyePos, Trenchant.eyeLookat, [0.0, 1.0, 0.0], Trenchant.viewMatrix);
            mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 1000.0, pMatrix);
            mat4.multiply(pMatrix, Trenchant.viewMatrix, pMatrix);

            mat4.identity(mvMatrix);

            mat4.translate(mvMatrix, [0, 0, -800]);
            mat4.rotate(mvMatrix, degToRad(23.4), [1, 0, -1]);
            mat4.rotate(mvMatrix, degToRad(teapotAngle), [0, 1, 0]);
            
            car.draw();           
        }

        var lastTime = 0;

        function animate() {
            var timeNow = new Date().getTime();
            if (lastTime != 0) {
                var elapsed = timeNow - lastTime;

                teapotAngle += 0.05 * elapsed;
            }
            lastTime = timeNow;
        }


        function tick() {
            requestAnimFrame(tick);
            car.setAnimate(pMatrix, mvMatrix);
            drawScene();
            animate();        
        }
        
        function onDocumentMouseMove( event ) {

            var mx = ( event.clientX - windowHalfX );
            var my = ( event.clientY - windowHalfY );
            
            Trenchant.eyeLookat[0]=mx;
            Trenchant.eyeLookat[1]=my;

        }
        
        function onDocumentOnKeyDown( event ){
            var d = [0, 0, 0]            
            vec3.normalize(Trenchant.eyeLookat, d);
            vec3.scale(d, 5, d);
            switch(event.keyCode) {
                case 87:
                    vec3.add(Trenchant.eyePos, d, Trenchant.eyePos);                    
                break;
                case 83:
                    vec3.subtract(Trenchant.eyePos, d, Trenchant.eyePos);
                break;
            }
        }

        function webGLStart() {
            var canvas = document.getElementById("trenchant_canvas");      
            initGL(canvas);        
            car = new Trenchant.Car();

            gl.clearColor(0.0, 0.0, 0.0, 1.0);
            gl.enable(gl.DEPTH_TEST);
            
            tick();
        }
	
	</script>
	</head>
	
	<body onload="webGLStart();">
		
		<canvas id="trenchant_canvas" style="border: none;" width="1400" height="700"></canvas>

	</body>

</html>